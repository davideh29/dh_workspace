<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Robotics Point Cloud Explorer</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="scene-container"></div>
    <form class="control-panel" id="controls" autocomplete="off">
      <h1 class="panel-title">Point Cloud</h1>
      <div class="control-group">
        <label for="seed">Seed</label>
        <input type="number" id="seed" name="seed" value="12345" step="1" />
      </div>
      <div class="control-group">
        <label for="numPoints">Points</label>
        <input
          type="number"
          id="numPoints"
          name="numPoints"
          min="100"
          max="100000"
          step="100"
          value="5000"
        />
      </div>
      <div class="control-group">
        <label for="radius">Radius <span class="value-display" data-for="radius">1.00</span></label>
        <input
          type="range"
          id="radius"
          name="radius"
          min="0.1"
          max="5"
          step="0.05"
          value="1"
        />
      </div>
      <div class="control-group">
        <label for="noise">Noise <span class="value-display" data-for="noise">0.02</span></label>
        <input
          type="range"
          id="noise"
          name="noise"
          min="0"
          max="0.2"
          step="0.002"
          value="0.02"
        />
      </div>
      <div class="control-group">
        <label for="colorMode">Color Mode</label>
        <select id="colorMode" name="colorMode">
          <option value="single">Single</option>
          <option value="height">Height</option>
        </select>
      </div>
      <div class="control-group checkbox">
        <label for="rotate">
          <input type="checkbox" id="rotate" name="rotate" checked />
          Auto rotate
        </label>
      </div>
    </form>

    <script type="module">
      import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
      import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
      import { initPointCloudApp } from './pointcloud.js';

      const defaults = {
        seed: 12345,
        numPoints: 5000,
        radius: 1,
        noise: 0.02,
        colorMode: 'single',
        rotate: true,
      };

      const container = document.getElementById('scene-container');
      const controlsForm = document.getElementById('controls');
      const valueDisplays = Array.from(
        document.querySelectorAll('[data-for]')
      );

      const app = initPointCloudApp(container, defaults, { THREE, OrbitControls });

      function clamp(value, min, max) {
        return Math.min(max, Math.max(min, value));
      }

      function getParamsFromForm() {
        const seedValue = Number(document.getElementById('seed').value);
        const numPointsValue = Number(document.getElementById('numPoints').value);
        const radiusValue = Number(document.getElementById('radius').value);
        const noiseValue = Number(document.getElementById('noise').value);

        return {
          seed: Number.isFinite(seedValue) ? Math.floor(seedValue) : 0,
          numPoints: Math.floor(
            clamp(Number.isFinite(numPointsValue) ? numPointsValue : 5000, 100, 100000)
          ),
          radius: clamp(radiusValue, 0.1, 5),
          noise: clamp(noiseValue, 0, 0.2),
          colorMode: document.getElementById('colorMode').value,
          rotate: document.getElementById('rotate').checked,
        };
      }

      function updateDisplays(params) {
        valueDisplays.forEach((element) => {
          if (element.dataset.for === 'radius') {
            element.textContent = params.radius.toFixed(2);
          }
          if (element.dataset.for === 'noise') {
            element.textContent = params.noise.toFixed(3);
          }
        });
      }

      function updateApp() {
        const params = getParamsFromForm();
        updateDisplays(params);
        app.setParams(params);
      }

      controlsForm.addEventListener('input', updateApp);
      controlsForm.addEventListener('change', updateApp);

      document.getElementById('colorMode').value = defaults.colorMode;
      updateDisplays(defaults);
      app.setParams(defaults);
    </script>
  </body>
</html>
